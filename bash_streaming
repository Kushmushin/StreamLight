#! usr/bin/bash

#Written by me, Kushmushin!
#Follow me on Youtube, Twitch, and Kick. All under Kushmushin.
#All I want in return is a like, a subscribe, and a follow. Help me get a new computer setup!


#-------------------------------------------------------------------------//////////
#----------------------------------------------------------////////// Base Functions
#-------------------------------------------------------------------------//////////

function streamfunctions() {
     grep '^function ' ~/.bash_streaming | awk '{print $2}' | sed 's/()//' | sort
}

#-------------------------------------------------------------------------//////////
#-------------------------------------------------------------////////// Cam Testing
#-------------------------------------------------------------------------//////////

#This opens your webcam in a new window.
function campipe() {
	ffplay -loglevel quiet -framerate 24 -video_size 640x480 /dev/video0
}

#-------------------------------------------------------------------------//////////
#-------------------------------------------------////////// Youtube Short Recording
#-------------------------------------------------------------------------//////////

#This records your desktop in a Youtube Short format. NO AUDIO!
function shortmaker() {
  OUTPUT="$HOME/Videos/shortmaker$(date +%Y%m%d_%H%M%S).mp4"

  figlet -f smslant "Recording..." | lolcat
  sleep 1

  ffmpeg \
    -loglevel quiet \
    -thread_queue_size 128 \
    -f x11grab \
    -framerate 20 \
    -video_size 720x900 \
    -i :0.0+440,0 \
    -vf "scale=720:900:force_original_aspect_ratio=decrease,pad=720:1280:0:(1280-900)/2:black" \
    -an \
    -c:v libx264 \
    -preset veryfast \
    -pix_fmt yuv420p \
    -b:v 2500k \
    -maxrate 2500k \
    -bufsize 5000k \
    -g 60 \
    -level 4.1 \
    -movflags +faststart \
    "$OUTPUT"

  clear
  figlet -f small "Recording Over" | lolcat
  sleep 1
  clear
}

#This records your desktop in a Youtube Short format. SYSTEM AUDIO! NO MICROPHONE!
function shortmaker_systemaudio() {
  OUTPUT="$HOME/Videos/shortmaker_systemaudio$(date +%Y%m%d_%H%M%S).mp4"

  figlet -f smslant "Recording..." | lolcat
  sleep 1

  ffmpeg \
    -loglevel quiet \
    -thread_queue_size 256 \
    -f x11grab \
    -framerate 30 \
    -video_size 720x900 \
    -i :0.0+440,0 \
    -thread_queue_size 256 \
    -f pulse \
    -ar 48000 \
    -i alsa_output.pci-0000_00_1b.0.analog-stereo.monitor \
    -vf "scale=720:900:force_original_aspect_ratio=decrease,pad=720:1280:0:(1280-900)/2:black" \
    -map 0:v \
    -map 1:a \
    -c:v libx264 \
    -preset fast \
    -crf 20 \
    -pix_fmt yuv420p \
    -profile:v high \
    -level 4.1 \
    -g 60 \
    -c:a aac \
    -b:a 128k \
    -ar 44100 \
    -ac 2 \
    -movflags +faststart \
    "$OUTPUT"

  clear
  figlet -f small "Recording Over" | lolcat
  sleep 1
  clear
}

#This records your desktop in a Youtube Short format. SYSTEM and MICROPHONE AUDIO!
function shortmaker_fullaudio() {
  OUTPUT="$HOME/Videos/shortmaker_fullaudio$(date +%Y%m%d_%H%M%S).mp4"

  figlet -f smslant "Recording..." | lolcat
  sleep 1

  ffmpeg \
    -loglevel quiet \
    -thread_queue_size 256 \
    -f x11grab \
    -framerate 30 \
    -video_size 720x900 \
    -i :0.0+440,0 \
    -thread_queue_size 256 \
    -f pulse \
    -ar 48000 \
    -thread_queue_size 512 -f pulse -ar 48000 -i alsa_output.pci-0000_00_1b.0.analog-stereo.monitor \
    -thread_queue_size 512 -f pulse -ar 48000 -i alsa_input.usb-Burr-Brown_from_TI_USB_Audio_CODEC-00.analog-stereo \
    -filter_complex "
      [0:v]scale=720:900:force_original_aspect_ratio=decrease,
           pad=720:1280:0:(1280-900)/2:black[v];
      [1:a]volume=1.0[a_sys];
      [2:a]adelay=2000|2000,
            pan=stereo|c0=c0|c1=c0,
            volume=1.4[a_mic];
      [a_sys][a_mic]amix=inputs=2:dropout_transition=0[a]
    " \
    -map "[v]" \
    -map "[a]" \
    -c:v libx264 \
    -preset fast \
    -crf 20 \
    -pix_fmt yuv420p \
    -profile:v high \
    -level 4.1 \
    -g 60 \
    -c:a aac \
    -b:a 128k \
    -ar 44100 \
    -ac 2 \
    -movflags +faststart \
    "$OUTPUT"

  clear
  figlet -f small "Recording Over" | lolcat
  sleep 1
  clear
}

#-------------------------------------------------------------------------//////////
#---------------------------------------------------////////// Desktop/Webcam Stream
#-------------------------------------------------------------------------//////////

#Let me be real here. Streaming to Youtube works like 50% of the time.
#YT is real B. Its hit or miss whether it wants to catch the feed.
#The Kick and Twitch work real well.
#I suggest recording using the other functions, then upoading to YT, rather than stream...
#Or stream to Twitch, then download it and post it to YT. Either or.
#I'll figure it out later.

function pip() {
    # $1 is the streaming service: twitch, kick, youtube
    SERVICE="$1"

    case "$SERVICE" in
        kick)
            : "${KICK_KEY:?KICK_KEY not set}"
            : "${KICK_RTMP:?KICK_RTMP not set}"
            KEY="$KICK_KEY"
            RTMP="$KICK_RTMP"
            ;;
        twitch)
            : "${TWITCH_KEY:?TWITCH_KEY not set}"
            : "${TWITCH_RTMP:?TWITCH_RTMP not set}"
            KEY="$TWITCH_KEY"
            RTMP="$TWITCH_RTMP"
            ;;
        yt|youtube)
            : "${YOUTUBE_KEY:?YOUTUBE_KEY not set}"
            : "${YOUTUBE_RTMP:?YOUTUBE_RTMP not set}"
            KEY="$YOUTUBE_KEY"
            RTMP="$YOUTUBE_RTMP"
            ;;
        *)
            echo "Unknown service: $SERVICE"
            return 1
            ;;
    esac

    figlet -f smslant "$SERVICE" | lolcat
    sleep 1

    ffmpeg \
    -loglevel quiet \
    -thread_queue_size 512 -f v4l2 -framerate 20 -video_size 320x240 -i /dev/video0 \
    -thread_queue_size 512 -f x11grab -framerate 20 -video_size 1280x720 -i :0.0+150,90 \
    -thread_queue_size 128 -loop 1 -i "$HOME/Pictures/bg_main.jpg" \
    -thread_queue_size 512 -f pulse -ar 48000 -i alsa_output.pci-0000_00_1b.0.analog-stereo.monitor \
    -thread_queue_size 512 -f pulse -ar 48000 -i alsa_input.usb-Burr-Brown_from_TI_USB_Audio_CODEC-00.analog-stereo \
    -filter_complex "
    [1:v]scale=-1:720:force_original_aspect_ratio=decrease,
         pad=1280:720:(ow-iw)/2:(oh-ih):color=black[desk];
    [0:v]scale=320x240,
         chromakey=0x384b81:0.05:0.05[cam_keyed];
    [2:v]scale=320x240[bg];
    [bg][cam_keyed]overlay=0:0[cam_final];
    [desk][cam_final]overlay=0:H-h[v];
    [3:a]volume=1.0[a_sys];
    [4:a]adelay=1000|1000,
          pan=stereo|c0=c0|c1=c0,
          volume=1.4[a_mic];
    [a_sys][a_mic]amix=inputs=2:dropout_transition=0[a]
    " \
    -map "[v]" \
    -map "[a]" \
    -c:v libx264 \
    -preset veryfast \
    -pix_fmt yuv420p \
    -b:v 2500k \
    -g 60 \
    -c:a aac \
    -b:a 160k \
    -ar 48000 \
    -ac 2 \
    -movflags +faststart \
    -f flv -flvflags no_duration_filesize "$RTMP/$KEY"

    clear
    figlet -f small "Stream Over" | lolcat
    sleep 1
    clear
}


#-------------------------------------------------------------------------//////////
#------------------------------------------////////// Desktop/Webcam Local Recording
#-------------------------------------------------------------------------//////////


function desktop_short() {
  OUTPUT="$HOME/Videos/desktop_short$(date +%Y%m%d_%H%M%S).mp4"

  figlet -f smslant "Recording..." | lolcat
  sleep 1

  ffmpeg \
  -loglevel quiet \
  -thread_queue_size 128 -f v4l2 -framerate 20 -video_size 640x480 -i /dev/video0 \
  -thread_queue_size 128 -f x11grab -framerate 20 -video_size 720x820 -i :0.0+430,80 \
  -thread_queue_size 128 -loop 1 -i "$HOME/Pictures/bg_main.jpg" \
  -thread_queue_size 512 -f pulse -ar 48000 -i alsa_output.pci-0000_00_1b.0.analog-stereo.monitor \
  -thread_queue_size 512 -f pulse -ar 48000 -i alsa_input.usb-Burr-Brown_from_TI_USB_Audio_CODEC-00.analog-stereo \
  -filter_complex "
    [1:v]scale=-1:720:force_original_aspect_ratio=decrease,
         pad=720:1280:(ow-iw)/2:(oh-ih):color=black[desk];
    [0:v]scale=640:480,
         chromakey=0x516ca0:0.05:0.05[cam_keyed];
    [2:v]scale=640:480[bg];
    [bg][cam_keyed]overlay=0:0[cam_final];
    [desk][cam_final]overlay=40:40[v];
    [3:a]volume=1.0[a_sys];
    [4:a]adelay=1000|1000,
          pan=stereo|c0=c0|c1=c0,
          volume=1.4[a_mic];
    [a_sys][a_mic]amix=inputs=2:dropout_transition=0[a]
  " \
  -map "[v]" \
  -map "[a]" \
  -c:v libx264 \
  -preset veryfast \
  -pix_fmt yuv420p \
  -b:v 2500k \
  -maxrate 2500k \
  -bufsize 5000k \
  -g 60 \
  -level 4.1 \
  -c:a aac \
  -b:a 96k \
  -ar 44100 \
  -ac 2 \
  -movflags +faststart \
  "$OUTPUT"

  clear
  figlet -f small "Recording Over" | lolcat
  sleep 1
  clear
}

function desktop_pip() {
  OUTPUT="$HOME/Videos/desktop_pip$(date +%Y%m%d_%H%M%S).mp4"

  figlet -f smslant "Recording..." | lolcat -a

  sleep 1

  ffmpeg \
    -loglevel quiet \
    -thread_queue_size 512 -f v4l2 -framerate 20 -video_size 320x240 -i /dev/video0 \
    -thread_queue_size 512 -f x11grab -framerate 20 -video_size 1280x720 -i :0.0+150,90 \
    -thread_queue_size 128 -loop 1 -i "$HOME/Pictures/bg_main.jpg" \
    -thread_queue_size 512 -f pulse -ar 48000 -i alsa_output.pci-0000_00_1b.0.analog-stereo.monitor \
    -thread_queue_size 512 -f pulse -ar 48000 -i alsa_input.usb-Burr-Brown_from_TI_USB_Audio_CODEC-00.analog-stereo \
    -filter_complex "
    [1:v]scale=-1:720:force_original_aspect_ratio=decrease,
         pad=1280:720:(ow-iw)/2:(oh-ih):color=black[desk];
    [0:v]scale=320x240,
         chromakey=0x384b81:0.05:0.05[cam_keyed];
    [2:v]scale=320x240[bg];
    [bg][cam_keyed]overlay=0:0[cam_final];
    [desk][cam_final]overlay=0:H-h[v];
    [3:a]volume=1.0[a_sys];
    [4:a]adelay=2000|2000,
          pan=stereo|c0=c0|c1=c0,
          volume=1.4[a_mic];
    [a_sys][a_mic]amix=inputs=2:dropout_transition=0[a]
  " \
    -map "[v]" \
    -map "[a]" \
    -c:v libx264 \
    -preset veryfast \
    -pix_fmt yuv420p \
    -b:v 2500k \
    -g 60 \
    -c:a aac \
    -b:a 160k \
    -ar 48000 \
    -ac 2 \
    -movflags +faststart \
    "$OUTPUT"

  clear
  figlet -f small "Recording Over" | lolcat
  sleep 1
  clear
}
